<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Ad Generator â€” Hugging Face (Arabic)</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family:'Cairo', system-ui; background:#0f1220; color:#fff; padding:20px; }
  .card { max-width:820px; margin:auto; background:#151936; border-radius:18px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  h1 { font-size:1.4rem; margin-bottom:8px; }
  p { color:#cbd0ff; font-size:.95rem; }
  label { display:block; margin-top:14px; font-weight:700; }
  input, textarea, button, select { width:100%; margin-top:8px; padding:12px; border-radius:12px; border:none; font-family:'Cairo'; }
  input, textarea, select { background:#0f1330; color:#fff; }
  button { background:#5b6cff; color:#fff; font-weight:800; cursor:pointer; }
  button.secondary { background:#2b2f6a; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .preview img, .out img { width:100%; border-radius:16px; margin-top:10px; cursor:pointer; }
  .range { display:flex; align-items:center; gap:10px; }
  .range span { opacity:.85; min-width:48px; text-align:center; }
  .note { font-size:.85rem; opacity:.8; margin-top:12px; background:#0f1330; padding:10px; border-radius:8px; }
  .actions { display:flex; gap:10px; margin-top:14px; }
  .error-box { background:#ff4d4d22; border:1px solid #ff4d4d; color:#ff4d4d; padding:10px; border-radius:8px; margin-top:10px; display:none; }
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”’</h1>
  <label>Username</label><input id="username" type="text" />
  <label>Password</label><input id="password" type="password" />
  <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
  <p id="loginMsg" style="color:#ff4d4d; opacity:.8; margin-top:8px;"></p>
</div>

<div class="card" id="mainCard" style="display:none;">
  <h1>Ù…ÙˆÙ„Ù‘Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø°ÙƒÙŠ (Hugging Face)</h1>
  <p>Ø§Ø±ÙØ¹ <b>ØªØµÙ…ÙŠÙ…Ù‹Ø§ Ù…Ø±Ø¬Ø¹ÙŠÙ‹Ø§</b> + <b>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</b>. Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Hugging Face API Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©.</p>

  <label>Hugging Face API Token</label>
  <input id="apiKey" type="password" placeholder="hf_..." />
  <div class="note">ğŸ”‘ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Ù…Ù† <a href="https://huggingface.co/settings/tokens" target="_blank" style="color:#5b6cff;">huggingface.co/settings/tokens</a> (Ù…Ø¬Ø§Ù†ÙŠ)</div>

  <div class="row">
    <div>
      <label>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© (Ø§Ù„ØªØµÙ…ÙŠÙ…)</label>
      <input id="template" type="file" accept="image/*" />
      <div class="preview" id="prevTemplate"></div>
    </div>
    <div>
      <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
      <input id="product" type="file" accept="image/*" />
      <div class="preview" id="prevProduct"></div>
    </div>
  </div>

  <label>Ù‚ÙˆØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ (Strength)</label>
  <div class="range">
    <input id="strength" type="range" min="0.1" max="1" step="0.05" value="0.5" />
    <span id="sval">0.50</span>
  </div>
  <div class="note">Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ù‚Ù„ = ØªØºÙŠÙŠØ± Ø·ÙÙŠÙ | Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø¹Ù„Ù‰ = ØªØºÙŠÙŠØ± Ø¬Ø°Ø±ÙŠ (Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§: 0.5)</div>

  <label>Seed (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ù†ÙØ³ Ø§Ù„Ù†ØªÙŠØ¬Ø© â€“ Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
  <input id="seed" type="number" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©" />

  <label>Ù†Ù…Ø· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©)</label>
  <select id="preset">
    <option value="stationery">Ù‚Ø±Ø·Ø§Ø³ÙŠØ© / Ù…ÙƒØªØ¨ÙŠØ©</option>
    <option value="electronics">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
    <option value="cosmetics">ØªØ¬Ù…ÙŠÙ„</option>
    <option value="general">Ø¹Ø§Ù…</option>
  </select>

  <label>Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ (Prompt)</label>
  <textarea id="prompt" rows="4"></textarea>
  <div class="note">ğŸ’¡ Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>

  <button id="run">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
  
  <div class="error-box" id="errorBox"></div>

  <div class="out" id="output"></div>

  <div class="note" style="margin-top:20px;">
    âš ï¸ <b>Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</b> Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ 10-30 Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…. Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ø®Ø·Ø£ "Model is loading"ØŒ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†Ù.
  </div>
  <div class="actions">
    <button id="editText" class="secondary" disabled>ğŸ–¼ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©</button>
  </div>
</div>

<script>
const presets = {
  stationery: 'Professional Arabic stationery advertisement, clean design, high quality, product photography style, modern layout, text space available',
  electronics: 'Modern Arabic electronics advertisement, sleek design, high tech, professional lighting, clean background, premium feel',
  cosmetics: 'Elegant Arabic cosmetics advertisement, soft lighting, luxury style, beautiful composition, high end product photography',
  general: 'Professional Arabic advertisement, high quality, clean composition, suitable for marketing, modern design'
};

const $ = (id)=>document.getElementById(id);

function previewFile(input, el){
  input.onchange = () => {
    const f = input.files[0]; if (!f) return;
    const img = document.createElement('img'); img.src = URL.createObjectURL(f);
    el.innerHTML=''; el.appendChild(img);
  }
}
previewFile($('template'), $('prevTemplate'));
previewFile($('product'), $('prevProduct'));

$('strength').oninput = ()=> $('sval').textContent = Number($('strength').value).toFixed(2);
$('preset').onchange = ()=> $('prompt').value = presets[$('preset').value];
$('prompt').value = presets.stationery;

const historyImages = [];

// LOGIN SYSTEM
console.log('Setting up login button...');
$('loginBtn').onclick = async ()=>{
  console.log('Login button clicked!');
  const u = $('username').value.trim();
  const p = $('password').value.trim();
  console.log('Username:', u);
  
  if(!u || !p){ 
    $('loginMsg').textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'; 
    console.log('Missing username or password');
    return; 
  }
  
  try{
    console.log('Sending login request...');
    const res = await fetch('/.netlify/functions/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username:u,password:p})
    });
    
    console.log('Response status:', res.status);
    const data = await res.json();
    console.log('Response data:', data);
    
    if(data.success){
      console.log('Login successful!');
      $('loginCard').style.display='none';
      $('mainCard').style.display='block';
    }else{
      console.log('Login failed:', data.message);
      $('loginMsg').textContent = data.message || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
    }
  }catch(e){ 
    console.error('Login error:', e);
    $('loginMsg').textContent='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + e.message; 
  }
}

// OPEN EDITOR
function openEditor(url){
  window.open(`editor.html?img=${encodeURIComponent(url)}`, '_blank');
}

// BASE64 HELPER
const toBase64 = (file)=> new Promise((res,rej)=>{
  const r=new FileReader();
  r.onload=()=>res(r.result);
  r.onerror=rej;
  r.readAsDataURL(file);
});

// SHOW ERROR
function showError(msg) {
  const box = $('errorBox');
  box.textContent = msg;
  box.style.display = 'block';
  setTimeout(() => { box.style.display = 'none'; }, 8000);
}

// GENERATE BUTTON
$('run').onclick = async ()=>{
  if(!$('apiKey').value || !$('template').files[0]){
    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù€ API Token ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©');
    return;
  }
  
  $('run').disabled=true; 
  $('run').textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡â€¦ (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 30 Ø«Ø§Ù†ÙŠØ© ÙÙŠ Ø£ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù…)';
  $('output').innerHTML='';
  $('errorBox').style.display = 'none';

  const body = {
    apiKey: $('apiKey').value.trim(),
    prompt: $('prompt').value,
    strength: Number($('strength').value),
    seed: $('seed').value ? Number($('seed').value) : null,
    template: await toBase64($('template').files[0]),
    product: $('product').files[0] ? await toBase64($('product').files[0]) : null
  };

  try{
    const res = await fetch('/.netlify/functions/generate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    
    const data = await res.json();
    
    // Handle specific Hugging Face errors
    if(res.status === 503 && data.error && data.error.includes('loading')) {
      showError('Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ­Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ (Cold Start). Ø§Ù†ØªØ¸Ø± 10-20 Ø«Ø§Ù†ÙŠØ© Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
      throw new Error('Model loading');
    }
    
    if(!res.ok) {
      throw new Error(data.error || `HTTP ${res.status}`);
    }
    
    if(!data.images || !data.images[0]) throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ ØµÙˆØ±Ø©');

    data.images.forEach(url=>{
      const wrapper=document.createElement('div');
      wrapper.style.marginTop = '20px';
      
      const img=document.createElement('img'); 
      img.src=url;
      img.onclick=()=>openEditor(url);

      const btn=document.createElement('button'); 
      btn.textContent='â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'; 
      btn.className='secondary';
      btn.onclick=()=>{ 
        const a=document.createElement('a'); 
        a.href=url; 
        a.download='ad-generated.png'; 
        a.click(); 
      };
      
      const editBtn = document.createElement('button');
      editBtn.textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ';
      editBtn.className = 'secondary';
      editBtn.style.marginRight = '10px';
      editBtn.onclick = () => openEditor(url);

      wrapper.appendChild(img);
      const btnContainer = document.createElement('div');
      btnContainer.style.marginTop = '10px';
      btnContainer.appendChild(editBtn);
      btnContainer.appendChild(btn);
      wrapper.appendChild(btnContainer);
      
      $('output').appendChild(wrapper);

      historyImages.unshift(url);
      if(historyImages.length>10) historyImages.pop();
    });

  }catch(e){ 
    console.error(e);
    if(!e.message.includes('Model loading')) {
      showError('Ø®Ø·Ø£: ' + e.message); 
    }
  }
  finally{ 
    $('run').disabled=false; 
    $('run').textContent='Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†'; 
  }
};
</script>
</body>
</html>
